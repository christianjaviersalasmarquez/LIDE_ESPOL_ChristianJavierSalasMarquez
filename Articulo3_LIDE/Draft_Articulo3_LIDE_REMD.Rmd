---
title: "Artículo 3. REMD."
author: "Christian Javier Salas Marquez"
date: '2022'
output:
  html_document:
    df_print: paged
---


```{r include=FALSE}
## --------------------------------------------------------------------------- ##
## ------------------------------ Librerías ---------------------------------- ##
## --------------------------------------------------------------------------- ##

if(!require(tidyverse)) install.packages("tidyverse", repos = "http://cran.us.r-project.org")
if(!require(haven)) install.packages("haven", repos = "http://cran.us.r-project.org")
if(!require(readr)) install.packages("readr", repos = "http://cran.us.r-project.org")
if(!require(survival)) install.packages("survival", repos = "http://cran.us.r-project.org")
if(!require(ggfortify)) install.packages("ggfortify", repos = "http://cran.us.r-project.org")
if(!require(hexbin)) install.packages("hexbin", repos = "http://cran.us.r-project.org")
if(!require(ggpointdensity)) install.packages("ggpointdensity", repos = "http://cran.us.r-project.org")
if(!require(RColorBrewer)) install.packages("RColorBrewer", repos = "http://cran.us.r-project.org")
if(!require(survminer)) install.packages("survminer", repos = "http://cran.us.r-project.org")
if(!require(gridExtra)) install.packages("gridExtra", repos = "http://cran.us.r-project.org")
if(!require(grid)) install.packages("grid", repos = "http://cran.us.r-project.org")
```




```{r include=FALSE}
## --------------------------------------------------------------------------- ##
## ---------------------------- Bases de datos ------------------------------- ##
## --------------------------------------------------------------------------- ##

EMA_2014 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2014/Matrimonios_2014.sav?raw=true')

EDV_2014 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2014/Divorcios_2014.sav?raw=true')
```


```{r include=FALSE}
EMA_2015 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2015/matrimonios%202015.sav?raw=true')

EDV_2015 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2015/divorcios%202015.sav?raw=true')
```


```{r include=FALSE}
EMA_2016 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2016/EMA%202016%20.sav?raw=true')

EDV_2016 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2016/EDV%202016.sav?raw=true')
```


```{r include=FALSE}
EMA_2017 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2017/EMA%202017.sav?raw=true')

EDV_2017 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2017/EDV%202017.sav?raw=true')
```


```{r include=FALSE}
EMA_2018 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2018/EMA%202018.sav?raw=true')

EDV_2018 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2018/EDV%202018.sav?raw=true')
```


```{r include=FALSE}
EMA_2019 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2019/EMA_2019.sav?raw=true')

EDV_2019 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2019/EDV_2019.sav?raw=true')
```


```{r include=FALSE}
EMA_2020 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2020/EMA_2020.sav?raw=true')

EDV_2020 <- read_sav(file = 'https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Databases_REMD/REMD_2020/EDV_2020.sav?raw=true')
```


### Introducción

Para investigar la situación de los matrimonios y divorcios en el Ecuador, en este artículo se presenta un análisis de supervivencia considerando como tiempo de estudio el periodo de tiempo entre 2014 y 2019, es decir, tomando como punto de inicio los matrimonios que comenzaron en 2014. En pocas palabras, un análisis de supervivencia permite estimar la probabilidad de que sobreviva un evento, en este caso un matrimonio. Para lograr ejecutar este análisis, utilizamos las bases de datos de matrimonios y divorcios del 2014 al 2019 proporcionadas por el Instituto Nacional de Estadística y Censos INEC.


Para realizar un análisis de supervivencia en este contexto, es necesario disponer de la duración del matrimonio y una variable que indique si el divorcio ocurrió o no. Para lograrlo, construimos un identificador de código único para cada matrimonio, para posteriormente emparejar la base de datos de matrimonios del 2014 con los matrimonios que acabaron en divorcio que están presentes en las bases de datos de divorcios del 2014 al 2019. El identificador está basado en la fecha de matrimonio, la fecha de nacimiento del esposo y la fecha de nacimiento de la esposa.


Para ejecutar este análisis de supervivencia, consideramos la base de datos de matrimonios del 2014 junto a las bases de datos de divorcios de los años 2014, 2015, 2016, 2017, 2018 y 2019. Por otro lado, es importante definir que el _estimador de Kaplan Meier_ es un modelo estadístico utilizado para estimar la probabilidad de supervivencia en el tiempo. 

### Resumen descriptivo

Dado que tomamos como base los matrimonios del año 2014, revisemos qué ocurre con las edades del novio y de la novia en ese año. 



```{r echo=FALSE}
ggplot( EMA_2014 %>% filter(edad_hom != 999 & edad_muj != 999 & edad_muj != 114 & edad_muj != 103) , aes(x = edad_hom, y = edad_muj)) + 
  geom_pointdensity(size = 0.8,position = 'jitter') + 
  scale_color_binned() +
  theme_bw() +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  xlab("Edad del Novio") +
  ylab("Edad de la Novia") +
  labs(title = "Edad del novio y edad de la novia de los matrimonios del 2014 en Ecuador", caption = "\n \n Fuente: Base de datos de Matrimonios 2014 - INEC", color = "Matrimonios") 
```

Este gráfico muestra un diagrama de dispersión junto a un código de color que indica cuántos matrimonios ocurrieron en la cercanía de cada punto. Este tipo de diagrama es necesario dado que la base de datos de matrimonios del 2014 tiene 60315 matrimonios. Es decir, en este gráfico tenemos 60315 puntos. Cada punto es coloreado por el número de puntos vecinos. De esta forma, nos damos cuenta que la mayoría de matrimonios fueron de parejas cuyas edades estaban entre los 20 y 30 años.




```{r eval=FALSE, include=FALSE}
# Gráfico de validación
# Permite observar el número de conteos en cada bin

ggplot( EMA_2014 %>% filter(edad_hom != 999 & edad_muj != 999 & edad_muj != 114 & edad_muj != 103) , aes(x = edad_hom, y = edad_muj)) + 
  geom_bin2d(binwidth = 1) + 
  stat_bin2d(geom = "text", aes(label = ..count..)) +
  theme_bw() +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  xlab("Edad del Novio") +
  ylab("Edad de la Novia") +
  labs(title = "Tabulación cruzada de la edad del novio y edad de la novia en Ecuador (2014)", caption = "\n \n Fuente: Registro Estadístico de Matrimonios 2014 - INEC", fill = "Conteo Matrimonios") +
  scale_fill_gradient(low="lightcyan", high = "red", limits = c(0, 4000))
```




### Análisis de supervivencia

```{r include=FALSE}
## --------------------------------------------------------------------------- ##
## ------------------------------- Filtros ----------------------------------- ##
## --------------------------------------------------------------------------- ##

df_M2014_EDV_2014 <- EDV_2014 %>%
  filter(anio_mat == 2014)

df_M2014_EDV_2015 <- EDV_2015 %>%
  filter(anio_mat == 2014)

df_M2014_EDV_2016 <- EDV_2016 %>%
  filter(anio_mat == 2014)

df_M2014_EDV_2017 <- EDV_2017 %>%
  filter(anio_mat == 2014)

df_M2014_EDV_2018 <- EDV_2018 %>%
  filter(anio_mat == 2014)

df_M2014_EDV_2019 <- EDV_2019 %>%
  filter(anio_mat == 2014)

```



```{r include=FALSE}
## --------------------------------------------------------------------------- ##
## ---------------------- DataFrame de análisis ------------------------------ ##
## --------------------------------------------------------------------------- ##

df_analisis_EMA_2014 <- EMA_2014
```

```{r eval=FALSE, include=FALSE}
# Validación

sum(is.na(df_analisis_EMA_2014$fecha_insc))
sum(is.na(df_analisis_EMA_2014$fecha_nach))
sum(is.na(df_analisis_EMA_2014$fecha_nacm))
```

```{r include=FALSE}
# Método 1: Omitiendo matrimonios cuyas fechas de nacimiento de contrayente o de la contrayente sean NA

df_analisis_EMA_2014 <- df_analisis_EMA_2014 %>% filter_at(vars(fecha_nach,fecha_nacm),all_vars(!is.na(.)))
```

```{r include=FALSE}
# Método 2: Validación

# df_analisis_EMA_2014 <- df_analisis_EMA_2014[!is.na(df_analisis_EMA_2014$fecha_nach) & !is.na(df_analisis_EMA_2014$fecha_nacm),]

# Ambos métodos generan el mismo resultado
```

```{r eval=FALSE, include=FALSE}
# Validación

sum(is.na(df_analisis_EMA_2014$fecha_nach))
sum(is.na(df_analisis_EMA_2014$fecha_nacm))
```


```{r include=FALSE}
## --------------------------------------------------------------------------- ##
## ------------------------- ID Matrimonios 2014 ----------------------------- ##
## --------------------------------------------------------------------------- ##

df_analisis_EMA_2014 <- df_analisis_EMA_2014 %>%
  unite(ID_EMA_2014, c('fecha_insc','fecha_nach','fecha_nacm'), sep = '', remove = FALSE)
```

```{r eval=FALSE, include=FALSE}
# OPCION 2

#df_analisis_EMA_2014 <- EMA_2014

#df_analisis_EMA_2014 <- df_analisis_EMA_2014 %>%
#  unite(ID_EMA_2014, c('fecha_nach','fecha_nacm'), sep = '', remove = FALSE)
```

```{r eval=FALSE, include=FALSE}
#options(scipen=999)

#f_compleja_paste_ID <- function(x) {
#  paste(unlist(strsplit(x, split='-', fixed = TRUE)), collapse = '')
#} 

```


```{r include=FALSE}
#options(scipen=999)

f_compleja_flatten_ID <- function(x) {
  str_flatten(unlist(strsplit(x, split='-', fixed = TRUE)), collapse = '')
} 

```

```{r eval=FALSE, warning=FALSE, include=FALSE}
#df_analisis_EMA_2014$ID_EMA_2014 <- unlist(lapply(df_analisis_EMA_2014$ID_EMA_2014, f_compleja_paste_ID ))
```

```{r warning=FALSE, include=FALSE}
df_analisis_EMA_2014$ID_EMA_2014 <- unlist(lapply(df_analisis_EMA_2014$ID_EMA_2014, f_compleja_flatten_ID ))
```


```{r eval=FALSE, include=FALSE}
# Validación

sum(is.na(df_analisis_EMA_2014$ID_EMA_2014))
```


```{r eval=FALSE, include=FALSE}
#df_analisis_EMA_2014 <- df_analisis_EMA_2014[!is.na(df_analisis_EMA_2014$ID_EMA_2014),] # Línea innecesaria dado los últimos ajustes a los chunks anteriores
```


```{r eval=FALSE, include=FALSE}
# Validación 

sum(is.na(df_analisis_EMA_2014$ID_EMA_2014))
```


```{r include=FALSE}
df_M2014_EDV_2016 <- df_M2014_EDV_2016 %>% filter_at(vars(fecha_nach,fecha_nacm),all_vars(!is.na(.)))
```



```{r include=FALSE}
## --------------------------------------------------------------------------- ##
## ------------ ID Matrimonio en bases de datos de divorcios ----------------- ##
## --------------------------------------------------------------------------- ##

df_M2014_EDV_2014 <- df_M2014_EDV_2014 %>%
  unite(ID_EMA_2014, c('fecha_mat','fecha_nach','fecha_nacm' ), sep = '', remove = FALSE)

df_M2014_EDV_2015 <- df_M2014_EDV_2015 %>%
  unite(ID_EMA_2014, c('fecha_mat','fecha_nach','fecha_nacm' ), sep = '', remove = FALSE)

df_M2014_EDV_2016 <- df_M2014_EDV_2016 %>%
  unite(ID_EMA_2014, c('fecha_mat','fecha_nach','fecha_nacm' ), sep = '', remove = FALSE)

df_M2014_EDV_2017 <- df_M2014_EDV_2017 %>%
  unite(ID_EMA_2014, c('fecha_mat','fecha_nach','fecha_nacm' ), sep = '', remove = FALSE)

df_M2014_EDV_2018 <- df_M2014_EDV_2018 %>%
  unite(ID_EMA_2014, c('fecha_mat','fecha_nach','fecha_nacm' ), sep = '', remove = FALSE)

df_M2014_EDV_2019 <- df_M2014_EDV_2019 %>%
  unite(ID_EMA_2014, c('fecha_mat','fecha_nac1','fecha_nac2' ), sep = '', remove = FALSE)

```


```{r eval=FALSE, include=FALSE}
# OPCION 2

#df_M2014_EDV_2014 <- df_M2014_EDV_2014 %>%
#  unite(ID_EMA_2014, c('fecha_nach','fecha_nacm'), sep = '', remove = FALSE)

#df_M2014_EDV_2015 <- df_M2014_EDV_2015 %>%
#  unite(ID_EMA_2014, c('fecha_nach','fecha_nacm'), sep = '', remove = FALSE)

#df_M2014_EDV_2016 <- df_M2014_EDV_2016 %>%
#  unite(ID_EMA_2014, c('fecha_nach','fecha_nacm'), sep = '', remove = FALSE)

#df_M2014_EDV_2017 <- df_M2014_EDV_2017 %>%
#  unite(ID_EMA_2014, c('fecha_nach','fecha_nacm'), sep = '', remove = FALSE)

#df_M2014_EDV_2018 <- df_M2014_EDV_2018 %>%
#  unite(ID_EMA_2014, c('fecha_nach','fecha_nacm'), sep = '', remove = FALSE)

#df_M2014_EDV_2019 <- df_M2014_EDV_2019 %>%
#  unite(ID_EMA_2014, c('fecha_nac1','fecha_nac2'), sep = '', remove = FALSE)
```


```{r include=FALSE}
df_M2014_EDV_2014$ID_EMA_2014 <- unlist(lapply(df_M2014_EDV_2014$ID_EMA_2014, f_compleja_flatten_ID))

df_M2014_EDV_2015$ID_EMA_2014 <- unlist(lapply(df_M2014_EDV_2015$ID_EMA_2014, f_compleja_flatten_ID))

df_M2014_EDV_2016$ID_EMA_2014 <- unlist(lapply(df_M2014_EDV_2016$ID_EMA_2014, f_compleja_flatten_ID))

df_M2014_EDV_2017$ID_EMA_2014 <- unlist(lapply(df_M2014_EDV_2017$ID_EMA_2014, f_compleja_flatten_ID))

df_M2014_EDV_2018$ID_EMA_2014 <- unlist(lapply(df_M2014_EDV_2018$ID_EMA_2014, f_compleja_flatten_ID))

df_M2014_EDV_2019$ID_EMA_2014 <- unlist(lapply(df_M2014_EDV_2019$ID_EMA_2014, f_compleja_flatten_ID))

```



```{r include=FALSE}
## --------------------------------------------------------------------------- ##
## ----------------- Construcción de nuevas variables ------------------------ ##
## --------------------------------------------------------------------------- ##

# Variable evento_divorcio
# 1: El matrimonio acabó en divorcio
# 0: El matrimonio continúa (Datos censurados por la derecha)

R_matrimonios_2014 <- dim(df_analisis_EMA_2014)[1]
evento_divorcio <- rep(0,R_matrimonios_2014)

for (i in 1:R_matrimonios_2014) {
  
  if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2014$ID_EMA_2014) {evento_divorcio[i] = 1}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2015$ID_EMA_2014) {evento_divorcio[i] = 1}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2016$ID_EMA_2014) {evento_divorcio[i] = 1}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2017$ID_EMA_2014) {evento_divorcio[i] = 1}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2018$ID_EMA_2014) {evento_divorcio[i] = 1}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2019$ID_EMA_2014) {evento_divorcio[i] = 1}
  
}

df_analisis_EMA_2014$evento_divorcio <- evento_divorcio

# Datos censurados por la derecha: El evento se observa sólo si ocurre antes del tiempo determinado de estudio. En este caso, un matrimonio que continúa después del tiempo de estudio (2014 a 2019) es una observación censurada por la derecha. Por lo tanto, en este caso, 0 indica los casos censurados. 

```


```{r include=FALSE}
R_matrimonios_2014 <- dim(df_analisis_EMA_2014)[1]
anio_divorcio <- rep(0,R_matrimonios_2014)

for (i in 1:R_matrimonios_2014) {
  
  if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2014$ID_EMA_2014) {anio_divorcio[i] = '2014'}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2015$ID_EMA_2014) {anio_divorcio[i] = '2015'}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2016$ID_EMA_2014) {anio_divorcio[i] = '2016'}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2017$ID_EMA_2014) {anio_divorcio[i] = '2017'}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2018$ID_EMA_2014) {anio_divorcio[i] = '2018'}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2019$ID_EMA_2014) {anio_divorcio[i] = '2019'}
  
}

df_analisis_EMA_2014$anio_divorcio_factor <- factor(anio_divorcio)
```


```{r include=FALSE}
R_matrimonios_2014 <- dim(df_analisis_EMA_2014)[1]
duracion_matrimonio <- rep(0,R_matrimonios_2014)

for (i in 1:R_matrimonios_2014) {
  
  if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2014$ID_EMA_2014) {duracion_matrimonio[i] = df_M2014_EDV_2014$dur_mat[match(c(df_analisis_EMA_2014$ID_EMA_2014[i]), df_M2014_EDV_2014$ID_EMA_2014)]}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2015$ID_EMA_2014) {duracion_matrimonio[i] = df_M2014_EDV_2015$dur_mat[match(c(df_analisis_EMA_2014$ID_EMA_2014[i]), df_M2014_EDV_2015$ID_EMA_2014)]}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2016$ID_EMA_2014) {duracion_matrimonio[i] = df_M2014_EDV_2016$dur_mat[match(c(df_analisis_EMA_2014$ID_EMA_2014[i]), df_M2014_EDV_2016$ID_EMA_2014)]}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2017$ID_EMA_2014) {duracion_matrimonio[i] = df_M2014_EDV_2017$dur_mat[match(c(df_analisis_EMA_2014$ID_EMA_2014[i]), df_M2014_EDV_2017$ID_EMA_2014)]}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2018$ID_EMA_2014) {duracion_matrimonio[i] = df_M2014_EDV_2018$dur_mat[match(c(df_analisis_EMA_2014$ID_EMA_2014[i]), df_M2014_EDV_2018$ID_EMA_2014)]}
  else if (df_analisis_EMA_2014$ID_EMA_2014[i] %in% df_M2014_EDV_2019$ID_EMA_2014) {duracion_matrimonio[i] = df_M2014_EDV_2019$dur_mat[match(c(df_analisis_EMA_2014$ID_EMA_2014[i]), df_M2014_EDV_2019$ID_EMA_2014)]}
  else {duracion_matrimonio[i] = 5}
  
}

df_analisis_EMA_2014$duracion_matrimonio <- duracion_matrimonio
```


```{r include=FALSE}
R_matrimonios_2014 <- dim(df_analisis_EMA_2014)[1]
hijos_rec_categoria <- rep(0, R_matrimonios_2014)

for (i in 1:R_matrimonios_2014) {
  
  if (df_analisis_EMA_2014$hijos_rec[i] == 99) {hijos_rec_categoria[i] = 'No aplica'}
  else if (df_analisis_EMA_2014$hijos_rec[i] == 0) {hijos_rec_categoria[i] = '0 hijos'}
  else if ( df_analisis_EMA_2014$hijos_rec[i] == 1 ) {hijos_rec_categoria[i] = '1 hijo'}
  else if ( df_analisis_EMA_2014$hijos_rec[i] == 2 ) {hijos_rec_categoria[i] = '2 hijos'}
  else if ( df_analisis_EMA_2014$hijos_rec[i] == 3 ) {hijos_rec_categoria[i] = '3 hijos'}
  else if ( df_analisis_EMA_2014$hijos_rec[i] >= 4 ) {hijos_rec_categoria[i] = '4 o más hijos'}
  
}

df_analisis_EMA_2014$hijos_rec_categoria <- hijos_rec_categoria
```


```{r include=FALSE}
R_matrimonios_2014 <- dim(df_analisis_EMA_2014)[1]
nacionalidad_pareja <- rep(0, R_matrimonios_2014)

for (i in 1:R_matrimonios_2014) {
  if (df_analisis_EMA_2014$nac_hom[i] == df_analisis_EMA_2014$nac_muj[i]) {nacionalidad_pareja[i] = 'Misma nacionalidad'}
  else {nacionalidad_pareja[i] = 'Diferentes nacionalidades'}
}

df_analisis_EMA_2014$nacionalidad_pareja <- nacionalidad_pareja
```


```{r eval=FALSE, include=FALSE}
names(attr(df_analisis_EMA_2014$niv_insth, "labels"))
names(attr(df_analisis_EMA_2014$niv_instm, "labels"))
```

```{r eval=FALSE, include=FALSE}
sum(is.na(df_analisis_EMA_2014$niv_insth))
sum(is.na(df_analisis_EMA_2014$niv_instm))
```

```{r include=FALSE}
df_analisis_EMA_2014 <- df_analisis_EMA_2014 %>%
  mutate(niv_insth_NA_replaced = replace_na( as.character(niv_insth), 'Dato faltante') )

df_analisis_EMA_2014 <- df_analisis_EMA_2014 %>%
  mutate(niv_instm_NA_replaced = replace_na( as.character(niv_instm), 'Dato faltante') )

```

```{r eval=FALSE, include=FALSE}
# Validación
summary(factor(df_analisis_EMA_2014$nivel_instruccion))
```

```{r include=FALSE}
R_matrimonios_2014 <- dim(df_analisis_EMA_2014)[1]
nivel_instruccion <- rep(0, R_matrimonios_2014)

for (i in 1:R_matrimonios_2014) {
  
  if (df_analisis_EMA_2014$niv_insth_NA_replaced[i] == 'Dato faltante' | df_analisis_EMA_2014$niv_instm_NA_replaced[i] == 'Dato faltante') {nivel_instruccion[i] = 'No aplica'}
  else if ( (df_analisis_EMA_2014$niv_insth_NA_replaced[i] == '9' ) | (df_analisis_EMA_2014$niv_instm_NA_replaced[i] == '9' ) ) {nivel_instruccion[i] = 'No aplica'}
  else if ( as.numeric(df_analisis_EMA_2014$niv_insth_NA_replaced[i]) > as.numeric(df_analisis_EMA_2014$niv_instm_NA_replaced[i]) ) {nivel_instruccion[i] = 'Hombre mayor nivel de instrucción'}
  else if ( as.numeric(df_analisis_EMA_2014$niv_instm_NA_replaced[i]) > as.numeric(df_analisis_EMA_2014$niv_insth_NA_replaced[i]) ) {nivel_instruccion[i] = 'Mujer mayor nivel de instrucción'}
  else if ( as.numeric(df_analisis_EMA_2014$niv_insth_NA_replaced[i]) == as.numeric(df_analisis_EMA_2014$niv_instm_NA_replaced[i]) ) {nivel_instruccion[i] = 'Igual nivel de instrucción'}
  
}

df_analisis_EMA_2014$nivel_instruccion <- nivel_instruccion
```


```{r include=FALSE}
# VALIDACIÓN
# Diferencia de edad

#df_analisis_EMA_2014 %>% 
#  filter(edad_hom != 999 & edad_muj != 999) %>%
#  mutate(diferencia_edad = abs(edad_hom - edad_muj))
```


```{r include=FALSE}
R_matrimonios_2014 <- dim(df_analisis_EMA_2014)[1]
diferencia_edad_categoria <- rep(0, R_matrimonios_2014)


for (i in 1:R_matrimonios_2014) {
  
  if (df_analisis_EMA_2014$edad_hom[i] == df_analisis_EMA_2014$edad_muj[i] ) {diferencia_edad_categoria[i] = 'Misma edad'}
  else if (df_analisis_EMA_2014$edad_hom[i] > df_analisis_EMA_2014$edad_muj[i] ) {diferencia_edad_categoria[i] = 'Hombre es mayor'}
  else if(df_analisis_EMA_2014$edad_muj[i] > df_analisis_EMA_2014$edad_hom[i] ) {diferencia_edad_categoria[i] = 'Mujer es mayor'}
  
}

df_analisis_EMA_2014$diferencia_edad_categoria <- diferencia_edad_categoria
```


```{r include=FALSE}
R_matrimonios_2014 <- dim(df_analisis_EMA_2014)[1]
etnia_pareja <- rep(0, R_matrimonios_2014)

for (i in 1:R_matrimonios_2014) {
  if(df_analisis_EMA_2014$p_etnica_hom[i] == df_analisis_EMA_2014$p_etnica_muj[i]) {etnia_pareja[i] = 'Misma etnia'}
  else {etnia_pareja[i] = 'Diferentes etnias'}
}

df_analisis_EMA_2014$etnia_pareja <- etnia_pareja
```






```{r eval=FALSE, include=FALSE}
# VALIDACIÓN

dim(df_M2014_EDV_2014)[1]
dim(df_M2014_EDV_2015)[1]
dim(df_M2014_EDV_2016)[1]
dim(df_M2014_EDV_2017)[1]
dim(df_M2014_EDV_2018)[1]
dim(df_M2014_EDV_2019)[1]

dim(df_M2014_EDV_2014)[1] + dim(df_M2014_EDV_2015)[1] + dim(df_M2014_EDV_2016)[1] + dim(df_M2014_EDV_2017)[1] + dim(df_M2014_EDV_2018)[1] + dim(df_M2014_EDV_2019)[1]

summary(factor(evento_divorcio)) 

sum(is.na(df_analisis_EMA_2014$ID_EMA_2014))

```


```{r eval=FALSE, include=FALSE}
# VALIDACIÓN 

summary(df_analisis_EMA_2014$anio_divorcio_factor)

```

```{r eval=FALSE, include=FALSE}
# VALIDACIÓN: MARGEN DE EMPAREJADOS

(19/46)*100 # 2014
(246/328)*100 # 2015
(502/637)*100 # 2016
(818/1021)*100 # 2017
(854/1024)*100 # 2018
(910/1093)*100 # 2019

# Algunos de los valores no emparejados corresponden a matrimonios del 2014 cuyas fechas de nacimiento presentaban NAs, por lo tanto no pudieron emparejarse.
```


```{r eval=FALSE, include=FALSE}
# VALIDACIÓN

# PORCENTAJES ORIGINAL

(46/4149)*100
(328/4149)*100
(637/4149)*100
(1021/4149)*100
(1024/4149)*100
(1093/4149)*100

print("-----")

# PORCENTAJES CODIGO UNICO DE LA FORMA fech_insc, fech_nacm, fech_nacm

(19/3349)*100
(246/3349)*100
(502/3349)*100
(818/3349)*100
(854/3349)*100
(910/3349)*100

print("-----")

# PORCENTAJES CODIGO UNICO DE LA FORMA fech_nacm, fech_nacm

(23/3605)*100
(257/3605)*100
(543/3605)*100
(876/3605)*100
(924/3605)*100
(982/3605)*100

```

 
```{r eval=FALSE, include=FALSE}
# VALIDACIÓN 

#df_analisis_EMA_2014 %>% filter(anio_divorcio_factor == 2014)

#View(df_analisis_EMA_2014 %>% filter(anio_divorcio_factor == 2014))

```

```{r eval=FALSE, include=FALSE}
# VALIDACIÓN 

n_distinct(df_analisis_EMA_2014$ID_EMA_2014)

n_distinct(df_M2014_EDV_2014$ID_EMA_2014)

n_distinct(df_M2014_EDV_2015$ID_EMA_2014)

n_distinct(df_M2014_EDV_2016$ID_EMA_2014)

n_distinct(df_M2014_EDV_2017$ID_EMA_2014)

n_distinct(df_M2014_EDV_2018$ID_EMA_2014)

n_distinct(df_M2014_EDV_2019$ID_EMA_2014)

```

```{r eval=FALSE, include=FALSE}
# VALIDACIÓN 

dim(df_analisis_EMA_2014)[1]

n_distinct(df_analisis_EMA_2014$ID_EMA_2014)

dim(df_analisis_EMA_2014)[1] - n_distinct(df_analisis_EMA_2014$ID_EMA_2014)

sum(duplicated(df_analisis_EMA_2014$ID_EMA_2014))

sum(is.na(df_analisis_EMA_2014$ID_EMA_2014))

```

```{r eval=FALSE, include=FALSE}
# VALIDACIÓN 

#df_analisis_EMA_2014$ID_EMA_2014[duplicated(df_analisis_EMA_2014$ID_EMA_2014)]

#sum(is.na(df_analisis_EMA_2014$ID_EMA_2014[duplicated(df_analisis_EMA_2014$ID_EMA_2014)]))

```

```{r eval=FALSE, include=FALSE}
# VALIDACIÓN 

# df_analisis_EMA_2014[ duplicated(df_analisis_EMA_2014$ID_EMA_2014) | duplicated(df_analisis_EMA_2014$ID_EMA_2014, fromLast = TRUE), ]

df_analisis_EMA_2014[ duplicated(df_analisis_EMA_2014$ID_EMA_2014), ] %>% select(ID_EMA_2014, evento_divorcio, anio_divorcio_factor) %>% filter(evento_divorcio == 1)

# 35 códigos duplicados. Algunos tienen DIVORCIO, VERIFICAR!

#df_analisis_EMA_2014[ duplicated(df_analisis_EMA_2014$ID_EMA_2014, fromLast = TRUE), ]

# 201402181971120419681220: Son 2 matrimonios diferentes. Mantener evento_divorcio = 1 en ambos.

# 201402141988030119921004: Matrimonio registrado 2 veces en EMA 2014. Omitir una de las filas duplicada.

# 201402141991102219951221: Matrimonio registrado 2 veces en EMA 2014. Omitir una de las filas duplicadas.

```


```{r include=FALSE}
# VALIDACIÓN

df_analisis_EMA_2014 <- df_analisis_EMA_2014[!(df_analisis_EMA_2014$ID_EMA_2014 == '201402141988030119921004' & df_analisis_EMA_2014$hijos_rec == 99),]

df_analisis_EMA_2014 <- df_analisis_EMA_2014[!(df_analisis_EMA_2014$ID_EMA_2014 == '201402141991102219951221' & df_analisis_EMA_2014$hijos_rec == 99),]

```

```{r eval=FALSE, include=FALSE}
# VALIDACIÓN

df_analisis_EMA_2014[ duplicated(df_analisis_EMA_2014$ID_EMA_2014), ] %>% select(ID_EMA_2014, evento_divorcio, anio_divorcio_factor) %>% filter(evento_divorcio == 1)
```


```{r include=FALSE}
df_merge_M2014_D2014 <- merge(df_analisis_EMA_2014, df_M2014_EDV_2014, by = c('ID_EMA_2014'))

df_merge_M2014_D2015 <- merge(df_analisis_EMA_2014, df_M2014_EDV_2015, by = c('ID_EMA_2014'))

df_merge_M2014_D2016 <- merge(df_analisis_EMA_2014, df_M2014_EDV_2016, by = c('ID_EMA_2014'))

df_merge_M2014_D2017 <- merge(df_analisis_EMA_2014, df_M2014_EDV_2017, by = c('ID_EMA_2014'))

df_merge_M2014_D2018 <- merge(df_analisis_EMA_2014, df_M2014_EDV_2018, by = c('ID_EMA_2014'))

df_merge_M2014_D2019 <- merge(df_analisis_EMA_2014, df_M2014_EDV_2019, by = c('ID_EMA_2014'))
```



### Estimador de Kaplan Meier 

Para fines de visualización, todas las escalas comienzan de tal forma que permitan observar a detalle los valores estimados (Usualmente de 90% a 100%). En realidad, la escala que debería utilizarse es de 0% a 100%, pero esto no permitiría observar las estimaciones en este caso y bajo el tiempo de estudio de este análisis.



```{r include=FALSE}
modelo1_KM <- survfit(Surv(time = df_analisis_EMA_2014$duracion_matrimonio, event = df_analisis_EMA_2014$evento_divorcio, type = 'right') ~ 1)
modelo1_KM
```

```{r include=FALSE}
summary(modelo1_KM)

# Existieron divorcios cuya fecha de divorcio y fecha de inscripción del divorcio eran de diferentes. Por tal motivo estos valores difieren a los de inscripciones de divorcio por año. 
```


```{r echo=FALSE}
autoplot(modelo1_KM, conf.int = FALSE) +
  labs(title = "Gráfica de supervivencia de Kaplan-Meier para los matrimonios \n", caption = "\n\n Fuente: Bases de datos de Matrimonios y Divorcios de 2014 a 2019 - INEC") +
  xlab('Tiempo (años)') + 
  ylab('Supervivencia estimada') +
  theme_classic() +
  theme(plot.title = element_text(colour = "grey20")) +
  theme(plot.caption = element_text(colour = "grey30")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "gray90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5), labels = scales::percent, limits = c(0.94,1)) 
```


En esta primera visualización, se presenta el gráfico de Kaplan Meier para todos los matrimonios. La gráfica de Kaplan Meier se interpreta de la siguiente forma: En el año 2014, el 99.8% de los matrimonios continúan. Para el 2015, el 99.2% de los matrimonios sobrevivieron. Para el 2016, sobrevive el 97.7% de los matrimonios. Para el 2017, el 96.3% de los matrimonios continúan. Para el 2018, el 94.9% de los matrimonios sobreviven. Finalmente, para el año 2019, el 94.4% de los matrimonios sobreviven. En otras palabras, el 94.9% de los matrimonios de 4 años sobrevive. Cabe recalcar que la duración 0 es para los parejas que se casaron en 2014 y se divorciaron en ese mismo año.



```{r include=FALSE}
modelo2_KM <- survfit(Surv(time = (df_analisis_EMA_2014 %>% filter(hijos_rec_categoria != 'No aplica'))$duracion_matrimonio, event = (df_analisis_EMA_2014 %>% filter(hijos_rec_categoria != 'No aplica') )$evento_divorcio) ~ (df_analisis_EMA_2014 %>% filter(hijos_rec_categoria != 'No aplica'))$hijos_rec_categoria)

modelo2_KM

```



```{r include=FALSE}
summary(modelo2_KM)
```







```{r echo=FALSE}
autoplot(modelo2_KM, conf.int = FALSE) + 
  labs(title = "Gráfica de supervivencia de Kaplan-Meier", caption = "\n\n Fuente: Bases de datos de Matrimonios y Divorcios de 2014 a 2019 - INEC", color = 'Hijos reconocidos') + 
  xlab('\n Tiempo (años)') + 
  ylab('Supervivencia estimada \n') +
  theme_classic() +
  theme(plot.title = element_text(colour = "grey20")) +
  theme(plot.caption = element_text(colour = "grey30")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "gray90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  theme(legend.background = element_rect(fill="white", size=0.5, linetype="solid", colour ="grey80")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 9), labels = scales::percent, limits = c(0.92,1)) 
```

La gráfica mostrada anteriormente corresponde a la estimación de Kaplan Meier considerando los hijos reconocidos del matrimonio (al momento del registro) como categorías. Con esta estimación, podemos observar que los matrimonios que tuvieron 0 hijos reconocidos al casarse, fueron los que menor probabilidad de supervivencia tuvieron. Además, podemos ver la tendencia de que entre más hijos tenía la pareja, menos probable era que se divorcien. En otras palabras, los matrimonios con al menos 1 hijo reconocido o más, sobrevivieron por más tiempo que los matrimonios con 0 hijos reconocidos. Por ejemplo, el 97.6% de los matrimonios de 5 años con 2 hijos reconocidos al momento del matrimonio sobreviven; el  95% de los matrimonios de 5 años con 1 hijo reconocido sobreviven; y el 93.6% de los matrimonios de 5 años con 0 hijos al momento del matrimonio sobreviven.



```{r eval=FALSE, include=FALSE}
# Por capitulación de bienes
# mcap_bie: Matrimonio con capitulación de bienes
# 1: Si
# 2: No
# 9: Ignorado

modelo3_KM <- survfit(Surv( (df_analisis_EMA_2014 %>% filter(mcap_bie != 9))$duracion_matrimonio , (df_analisis_EMA_2014 %>% filter(mcap_bie != 9))$evento_divorcio ) ~ (df_analisis_EMA_2014 %>% filter(mcap_bie != 9))$mcap_bie )
modelo3_KM
```

```{r eval=FALSE, include=FALSE}
summary(modelo3_KM)
```

```{r eval=FALSE, include=FALSE}
autoplot(modelo3_KM, conf.int = FALSE) + 
  labs(title = "Gráfica de supervivencia de Kaplan-Meier", caption = "\n\n Fuente: Bases de datos de Matrimonios y Divorcios de 2014 a 2019 - INEC", color = 'Capitulación de bienes') + 
  xlab('\n Tiempo (años)') + 
  ylab('Supervivencia estimada \n') +
  theme_classic() +
  theme(plot.title = element_text(colour = "grey20")) +
  theme(plot.caption = element_text(colour = "grey30")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "gray90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  theme(legend.background = element_rect(fill="white", size=0.5, linetype="solid", colour ="grey80")) +
  scale_color_hue(labels = c('Si','No')) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5), labels = scales::percent, limits = c(0.9,1)) 
```






```{r include=FALSE}
modelo4_KM <- survfit(Surv( df_analisis_EMA_2014$duracion_matrimonio , df_analisis_EMA_2014$evento_divorcio ) ~ df_analisis_EMA_2014$nacionalidad_pareja )
modelo4_KM
```

```{r include=FALSE}
summary(modelo4_KM)
```


```{r echo=FALSE, warning=FALSE}
autoplot(modelo4_KM, conf.int = FALSE) + 
  labs(title = "Gráfica de supervivencia de Kaplan-Meier", caption = "\n\n Fuente: Bases de datos de Matrimonios y Divorcios de 2014 a 2019 - INEC") +
  xlab('\n Tiempo (años)') + 
  ylab('Supervivencia estimada \n') +
  theme_classic() +
  theme(plot.title = element_text(colour = "grey20")) +
  theme(plot.caption = element_text(colour = "grey30")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(legend.title = element_blank()) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "gray90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  theme(legend.background = element_rect(fill="white", size=0.5, linetype="solid", colour ="grey80")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 6), labels = scales::percent, limits = c(0.90,1)) 
```

En este caso, podemos ver que los matrimonios de diferentes nacionalidades tienen menos probabilidad de supervivencia en todos los años analizados. A partir del año 1, la diferencia en la probabilidad de supervivencia es más marcada y va aumentando progresivamente. En particular, el 94.5% de los matrimonios de 5 años con contrayentes que tienen la misma nacionalidad sobreviven, y el 92.3% de matrimonios de 5 años con contrayentes de diferentes nacionalidades sobreviven.

Por otro lado, cabe resaltar que dentro de los matrimonios en el año 2014, `r (summary(factor(df_analisis_EMA_2014$nacionalidad_pareja)))` 1163 fueron matrimonios de parejas con diferentes nacionalidades y 59152 matrimonios fueron con parejas de misma nacionalidad.




```{r eval=FALSE, include=FALSE}
modelo5_KM <- survfit(Surv( (df_analisis_EMA_2014 %>% filter(nivel_instruccion != 'No aplica'))$duracion_matrimonio , (df_analisis_EMA_2014 %>% filter(nivel_instruccion != 'No aplica'))$evento_divorcio ) ~ (df_analisis_EMA_2014 %>% filter(nivel_instruccion != 'No aplica'))$nivel_instruccion )
modelo5_KM
```


```{r eval=FALSE, include=FALSE}
summary(modelo5_KM)
```


```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
autoplot(modelo5_KM, conf.int = FALSE) + 
  labs(title = "Gráfica de supervivencia de Kaplan-Meier", caption = "\n\n Fuente: Bases de datos de Matrimonios y Divorcios de 2014 a 2019 - INEC") +
  xlab('\n Tiempo (años)') + 
  ylab('Supervivencia estimada \n') +
  theme_classic() +
  theme(plot.title = element_text(colour = "grey20")) +
  theme(plot.caption = element_text(colour = "grey30")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(legend.title = element_blank()) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "gray90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5), labels = scales::percent, limits = c(0.94,1)) 
```



```{r eval=FALSE, include=FALSE}
modelo6_KM <- survfit(Surv( df_analisis_EMA_2014$duracion_matrimonio , df_analisis_EMA_2014$evento_divorcio ) ~ df_analisis_EMA_2014$diferencia_edad_categoria )
modelo6_KM
```

```{r eval=FALSE, include=FALSE}
summary(modelo6_KM)
```

```{r eval=FALSE, include=FALSE}
autoplot(modelo6_KM, conf.int = FALSE) +
  labs(title = "Gráfica de supervivencia de Kaplan-Meier", caption = "\n\n Fuente: Bases de datos de Matrimonios y Divorcios de 2014 a 2019 - INEC") +
  xlab('\n Tiempo (años)') + 
  ylab('Supervivencia estimada \n') +
  theme_classic() + 
  theme(plot.title = element_text(colour = "grey20")) +
  theme(plot.caption = element_text(colour = "grey30")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(legend.title = element_blank()) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "gray90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  theme(legend.background = element_rect(fill="white", size=0.5, linetype="solid", colour ="grey80")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5), labels = scales::percent, limits = c(0.94,1)) 
```


```{r eval=FALSE, include=FALSE}
modelo7_KM <- survfit(Surv( df_analisis_EMA_2014$duracion_matrimonio , df_analisis_EMA_2014$evento_divorcio ) ~ df_analisis_EMA_2014$etnia_pareja )
modelo7_KM
```

```{r eval=FALSE, include=FALSE}
summary(modelo7_KM)
```

```{r eval=FALSE, include=FALSE}
autoplot(modelo7_KM, conf.int = FALSE) + 
  xlab('\n Tiempo (años)') + 
  ylab('Supervivencia estimada \n') +
  labs(title = "Gráfica de supervivencia de Kaplan-Meier", caption = "\n\n Fuente: Bases de datos de Matrimonios y Divorcios de 2014 a 2019 - INEC") +
  theme_classic() + 
  theme(plot.title = element_text(colour = "grey20")) +
  theme(plot.caption = element_text(colour = "grey30")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(legend.title = element_blank()) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "gray90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  theme(legend.background = element_rect(fill="white", size=0.5, linetype="solid", colour ="grey80")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5), labels = scales::percent, limits = c(0.94,1)) 
  
```


```{r include=FALSE}
modelo8_KM <- survfit(Surv( (df_analisis_EMA_2014 %>% filter(est_civih != 9))$duracion_matrimonio , (df_analisis_EMA_2014 %>% filter(est_civih != 9))$evento_divorcio ) ~ (df_analisis_EMA_2014 %>% filter(est_civih != 9))$est_civih )

modelo9_KM <- survfit(Surv( (df_analisis_EMA_2014 %>% filter(est_civim != 9))$duracion_matrimonio , (df_analisis_EMA_2014 %>% filter(est_civim != 9))$evento_divorcio ) ~ (df_analisis_EMA_2014 %>% filter(est_civim != 9))$est_civim )

```

```{r include=FALSE}
summary(modelo8_KM)
summary(modelo9_KM)
```

```{r echo=FALSE, fig.height=6, fig.width=12, message=FALSE, warning=FALSE}
grid.arrange(
  
  autoplot(modelo8_KM, conf.int = FALSE) + 
  ylab('S(t)') + 
  ggtitle('Estado civil anterior del novio') + 
  theme_classic() +
  xlab('Tiempo (años)') + 
  ylab('\n Supervivencia estimada') +
  theme(plot.title = element_text(colour = "grey20")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(legend.title = element_blank()) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "grey90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  theme(legend.background = element_rect(fill="white", size=0.5, linetype="solid", colour ="grey80")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5), labels = scales::percent, limits = c(0.9,1)) +
  scale_color_manual(labels = c('Soltero','Divorciado','Viudo'), values = c('#00BA38','#F8766D','#619CFF') )
  
  ,
  
  autoplot(modelo9_KM, conf.int = FALSE) + 
  ylab('S(t)') + 
  ggtitle('Estado civil anterior de la novia') + 
  theme_classic() +
  xlab('Tiempo (años)') + 
  ylab('\n Supervivencia estimada') +
  theme(plot.title = element_text(colour = "grey20")) +
  theme(axis.title.x = element_text(colour = "grey30"),axis.title.y = element_text(colour = "grey30")) +
  theme(legend.title = element_blank()) +
  theme(line = element_blank()) +
  theme(panel.grid.major = element_line(color = "grey90", size = 0.5, linetype = 1)) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  theme(legend.background = element_rect(fill="white", size=0.5, linetype="solid", colour ="grey80")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 5), labels = scales::percent, limits = c(0.9,1)) +
  scale_color_manual(labels = c('Soltera','Divorciada','Viuda'), values = c('#00BA38','#F8766D','#619CFF') )
  
  ,
  ncol = 2
  ,
  top = textGrob("Gráficas de supervivencia de Kaplan-Meier \n", gp=gpar(fontsize=14,col="grey20",font=1))
  ,
  bottom= textGrob("\n Fuente: Bases de datos de Matrimonios y Divorcios de 2014 a 2019 - INEC", gp = gpar(fontsize=10,col="grey30",font=1))
  
)
```


Finalmente, en esta última visualización, se comparan las gráficas de Kaplan Meier de los matrimonios considerando por grupos de _Estado Civil Anterior del Novio_ y _Estado civil anterior de la novia_. Podemos observar que tanto para las estimaciones de Kaplan Meier para el estado civil anterior del novio como para el estado civil anterior de la novia, se tiene que los matrimonos que menos sobrevivieron fueron los que el novio ya era divorciado y la novia ya era divorciada. 

Para el primer gráfico, el 94.8% de matrimonios de 5 años en donde el estado civil anterior del novio fue de _Soltero_ sobreviven, mientras que el 91.6% de los matrimonios de 5 años en donde el estado civil anterior del novio fue de _Divorciado_ sobreviven. Análogamente, para el segundo gráfico, el 94.7% de los matrimonios de 5 años en donde el estado civil anterior de la novia fue de _Soltera_ sobreviven, mientras que el 90.9% de los matrimonios de 5 años en donde el estado civil anterior de la novia fue de _Divorciada_ sobreviven. 



### Conclusiones

En conclusión, el modelo de Kaplan Meier permitió estimar la probabilidad de supervivencia en el tiempo de los matrimonios considerando como intervalo de tiempo los años transcurridos desde 2014 a 2019. Cabe recalcar que, para poder hacer inferencia sobre las probabilidades de supervivencia, es necesario utilizar una prueba de hipótesis de Log-rank u otros modelos estadísticos como la regresión de Cox. La prueba de Log-rank compara las probabilidades de supervivencia entre dos grupos. Es importante especificar que para hacer generalizaciones para toda la población, sería necesario ejecutar pruebas de hipótesis y hacer un ajuste con los modelos mencionados.

Entre los principales resultados obtenidos tenemos:

* Los matrimonios con 0 hijos reconocidos al momento de casarse, fueron los que menor probabilidad de supervivencia tuvieron. Además, existe una tendencia de que mientras más hijos tenía la pareja de esposos, mayor era la probabilidad de supervivencia. En otras palabras, los matrimonios con al menos 1 hijo reconocido o más, sobrevivieron por más tiempo que los matrimonios con 0 hijos reconocidos.

* Los matrimonios de esposos de diferentes nacionalidades tienen menor probabilidad de supervivencia en todos los años analizados comparado con los matrimonios de esposos de misma nacionalidad. Sin embargo, para verificar si la diferencia es significativa o no, es necesario realizar pruebas de hipótesis.

* Los matrimonos en donde el estado civil anterior del novio y de la novia eran de _Divorciado_ y _Divorciada_, respectivamente, fueron los que menos sobrevivieron, comparado con los matrimonios en donde el estado civil anterior del novio y de la novia eran de _Soltero_ y _Soltera_, respectivamente.


```{r include=FALSE}
## --------------------------------------------------------------------------- ##
## ---------------------------- Log-rank test -------------------------------- ##
## --------------------------------------------------------------------------- ##

# Correspondiente al Modelo4_KM
# Nivel de significancia considerado: 0.05

survdiff(Surv( df_analisis_EMA_2014$duracion_matrimonio , df_analisis_EMA_2014$evento_divorcio ) ~ df_analisis_EMA_2014$nacionalidad_pareja, rho = 0 ) # rho = 0 para ejecutar la prueba de log-rank o Mantel Haenszel

# Se obtiene un valor p = 0.001 menor al nivel de significancia de 0.05. Por lo tanto, existe evidencia estadística para rechazar la hipótesis nula. Entonces, concluimos que existe una diferencia estadísticamente significativa en la supervivencia en los matrimonios de los grupos de diferente nacionalidad y misma nacionalidad.
```

```{r eval=FALSE, include=FALSE}
# Validación
ggsurvplot( survfit(Surv( df_analisis_EMA_2014$duracion_matrimonio , df_analisis_EMA_2014$evento_divorcio ) ~ df_analisis_EMA_2014$nacionalidad_pareja, data = df_analisis_EMA_2014 ) , conf.int = TRUE, pval = TRUE )
```



Para más información y para obtener resultados de una prueba de hipótesis de Log-rank, puedes revisar el código en nuestro repositorio de [GitHub](https://github.com/christianjaviersalasmarquez/LIDE_ESPOL_Christian_Salas/blob/main/Articulo3_LIDE/Draft_Articulo3_LIDE_REMD.Rmd) .



### Notas metodológicas importantes

(1) Para construir el identificador o código único para emparejar los matrimonios con los divorcios, se utilizó la fecha del matrimonio, fecha de nacimiento del contrayente y fecha de nacimiento de la contrayente (en la base de datos de matrimonios del 2014). Para crear el identificador en las bases de datos de divorcio de 2014 a 2019, se utilizaron las variables de la fecha del matrimonio, fecha de nacimiento del divorciado y fecha de nacimiento de la divorciada.

(2) No se consideró el año 2020 dado que, debido a la pandemia, los matrimonios y divorcios disminuyeron drásticamente en comparación con años anteriores. 

(3) Existieron divorcios que no fueron emparejados dado que no existían en la base de matrimonios del 2014 (a pesar de que los divorcios fueron filtrados considerando que el año de matrimonio sea 2014). Además, no se garantiza un emparejamiento total dado que las variables para crear el código único de matrimonio utilizadas (fechas de nacimiento) podrían estar sujetas a errores de tipeo o presentar datos faltantes en algunos casos.


(4) Para fines de visualización, todas las escalas de los gráficos de Kaplan Meier comienzan de tal forma que permitan observar a detalle los valores estimados (Usualmente de 90% a 100%). En realidad, la escala que debería utilizarse es de 0% a 100%. Pero en este caso, si se utilizara la escala de 0% a 100%, esto no permitiría observar las estimaciones con claridad.


(5) Para poder hacer inferencia sobre las probabilidades de supervivencia, es necesario utilizar pruebas de hipótesis, tales como la prueba de Log-rank y otros modelos estadísticos utilizados en el análisis de supervivencia, tales como la regresión de Cox.




### Referencias


Clark, T., Bradburn, M., Love, S. et al. Survival Analysis Part I: Basic concepts and first analyses. Br J Cancer 89, 232–238 (2003). https://doi.org/10.1038/sj.bjc.6601118

Bewick, V., Cheek, L., & Ball, J. (2004). Statistics review 12: survival analysis. Critical care (London, England), 8(5), 389–394. https://doi.org/10.1186/cc2955

Gutiérrez Burbano, Álvaro Marcelo (2017). Análisis de supervivencia de matrimonios del Ecuador en base a los datos publicados por el INEC desde 1997 hasta 2015. [Trabajo Fin de Máster]. Recuperado de: https://eprints.ucm.es/id/eprint/43956/

Instituto Nacional de Estadística y Censos INEC. (2014). 'Estadística de Matrimonios y Divorcios 2014' [Base de datos]. Recuperado de: https://www.ecuadorencifras.gob.ec//estadistica-de-matrimonios-y-divorcios-2014/

Instituto Nacional de Estadística y Censos INEC. (2015). 'Estadística de Matrimonios y Divorcios 2015' [Base de datos]. Recuperado de: https://www.ecuadorencifras.gob.ec/matrimonios-y-divorcios-2015/

Instituto Nacional de Estadística y Censos INEC. (2016). 'Estadística de Matrimonios y Divorcios 2016' [Base de datos]. Recuperado de: https://www.ecuadorencifras.gob.ec/estadistica-de-matrimonios-y-divorcios-2016/

Instituto Nacional de Estadística y Censos INEC. (2017). 'Estadística de Matrimonios y Divorcios 2017' [Base de datos]. Recuperado de: https://www.ecuadorencifras.gob.ec/estadistica-de-matrimonios-y-divorcios-2017/

Instituto Nacional de Estadística y Censos INEC. (2018). 'Registro Estadístico de Matrimonios y Divorcios 2018' [Base de datos]. Recuperado de: https://www.ecuadorencifras.gob.ec/matrimonios-y-divorcios-2018/

Instituto Nacional de Estadística y Censos INEC. (2019). 'Registro Estadístico de Matrimonios y Divorcios 2019' [Base de datos]. Recuperado de: https://www.ecuadorencifras.gob.ec/matrimonios-y-divorcios-2019/

Instituto Nacional de Estadística y Censos INEC. (2020a). 'Registro Estadístico de Matrimonios y Divorcios 2020' [Base de datos]. Recuperado de: https://www.ecuadorencifras.gob.ec/matrimonios-y-divorcios-2020/

Instituto Nacional de Estadística y Censos INEC. (2020b). Boletín Técnico N°01-2020-REMD. Registro Estadístico de Matrimonios y Divorcios, 2019. Ecuador. Recuperado de: https://www.ecuadorencifras.gob.ec/documentos/web-inec/Poblacion_y_Demografia/Matrimonios_Divorcios/2019/Boletin_tecnico_MYD_2019.pdf

